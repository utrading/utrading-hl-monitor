# Address Signal 数量限制清理

**日期**: 2026-02-13
**状态**: 待实施

## 背景

现有的 `cleanAddressSignals` 方法仅基于时间条件（保留 7 天）清理信号。随着业务增长，7 天内的信号数量可能超过数据库存储限制或影响查询性能。

## 我们要构建什么

为 Address Signal 清理逻辑增加**数量限制**条件：当信号总数超过 50 万条时，删除最旧的超出部分。

## 清理策略

**执行顺序**：时间优先，数量兜底

```
1. 先删除 7 天前的信号（现有逻辑）
      ↓
2. 检查剩余信号总数
      ↓
3. 如果总数 > 50 万 → 删除最旧的 (总数 - 50 万) 条
```

**示例**：
- 清理 7 天前记录后剩余 520,000 条
- 超出数量 = 520,000 - 500,000 = 20,000
- 删除最旧的 20,000 条记录

## 关键决策

| 决策点 | 选择 | 理由 |
|--------|------|------|
| 限制范围 | 总记录数 | 防止表膨胀，控制整体存储 |
| 删除策略 | 删除超出数量 | 保持 50 万条最新记录，避免过度删除 |
| 执行顺序 | 时间优先 | 先执行时间清理可减少数量清理的工作量 |

## 影响范围

**修改文件**：
- `internal/dao/signal.go` - 新增 `Count()` 和 `DeleteOldest(limit)` 方法
- `internal/cleaner/cleaner.go` - 修改 `cleanAddressSignals()` 增加数量检查

## 开放问题

无
